import{u as F,m as h,n as w,q as E,aa as x,b as C,ab as _,j as s,W as q,ac as v,B as N,ad as T,r as y,T as m,a5 as j,E as f,Z as I,ae as k,L as B,O as D}from"./index-DPBpgKE4.js";import{E as A}from"./ErrorFallback-BToUuPOP.js";import{A as b,a as $,b as R}from"./AccordionSummary-De0VuQWi.js";function S({defaultValues:i,submitButtonText:u="Update Analytics Rule"}){const r=F(),[c,l]=h(),o=w({mutationFn:({name:a,schema:t})=>c.analytics.rules().upsert(a,t),onMutate:a=>{r.loading("saving analytics rule",{id:`rule-updated-${a.name}`})},onSuccess:(a,t,e)=>{console.log(a,t,e),r.success("analytics rule saved",{id:`rule-updated-${t.name}`})},onError:(a,t,e)=>{console.log(a,t,e);let n=(a==null?void 0:a.message)||"failed to save analytics rule";r.error(n,{id:`rule-updated-${t.name}`})},onSettled:()=>{E.invalidateQueries({queryKey:x.rules(l)})}}),d=C({..._,defaultValues:i,onSubmit:async({value:a})=>{const{name:t,type:e,params:n}=a,p={type:e,params:{...n,limit:isNaN(Number(n.limit))?void 0:Number(n.limit)}};try{let g=await o.mutateAsync({name:t,schema:p});console.log("RESETTING FORM...",g),d.reset()}catch{}}});return s.jsx(K,{form:d,submitButtonText:u})}function K({form:i,submitButtonText:u}){const[r,c]=h(),{data:l}=q({queryKey:v.names(c,{withAlias:!0}),queryFn:async()=>{let o=await r.collections().retrieve(),d=await r.aliases().retrieve(),a=o.map(e=>e.name);return[...d.aliases.map(e=>e.name),...a]}});return s.jsx(N,{component:"form",onSubmit:o=>{o.preventDefault(),o.stopPropagation(),i.handleSubmit()},noValidate:!0,children:s.jsx(T,{form:i,sourceOptions:l,destinationOptions:l,submitButtonText:u})})}function O(){const[i,u]=h(),{data:r}=q({queryKey:x.rules(u),queryFn:async()=>(await i.analytics.rules().retrieve()).rules}),c=F(),l=w({mutationFn:e=>i.analytics.rules(e).delete(),onMutate:e=>{c.success(`deleting ["${e}"]`,{id:`${e}-delete`})},onSuccess:(e,n)=>{c.success(`"${n}" deleted`,{id:`${n}-delete`})},onError:(e,n)=>{c.success(`failed to delete rule ["${n}"]`,{id:`${n}-delete`})},onSettled:()=>{E.invalidateQueries({queryKey:x.rules(u)})}}),[o,d]=y.useState(null),a=e=>(n,p)=>{d(p?e:null)},t=e=>{l.mutate(e)};return s.jsxs(s.Fragment,{children:[r.map((e,n)=>s.jsxs(b,{expanded:o===`${e.name}-${n}`,onChange:a(`${e.name}-${n}`),children:[s.jsx($,{expandIcon:s.jsx(j,{}),"aria-controls":`${e.name}-${n}-content`,id:`${e.name}-${n}-header`,children:s.jsx(m,{variant:"h6",children:e.name})}),s.jsx(R,{children:s.jsx(f,{FallbackComponent:A,children:s.jsxs(y.Suspense,{children:[s.jsx(S,{defaultValues:{name:e.name,type:e.type,params:{source:{collections:e.params.source.collections},destination:{collection:e.params.destination.collection},enable_auto_aggregation:e.params.enable_auto_aggregation||!1,expand_query:e.params.expand_query||!1,limit:e.params.limit?String(e.params.limit):""}}}),s.jsx(I,{onClick:()=>t(e.name),loading:l.isPending&&l.variables===e.name,disabled:l.isPending,sx:{my:1},color:"error",children:"Delete"})]})})})]},e.name)),s.jsxs(b,{expanded:o==="new",onChange:a("new"),children:[s.jsx($,{expandIcon:s.jsx(j,{}),"aria-controls":"new-content",id:"new-header",children:s.jsx(m,{variant:"h6",children:"Add New Analytics Rule"})}),s.jsx(R,{children:s.jsx(f,{FallbackComponent:A,children:s.jsx(y.Suspense,{children:s.jsx(S,{defaultValues:k,submitButtonText:"Add Analytics Rule"})})})})]})]})}const L=function(){return s.jsxs(s.Fragment,{children:[s.jsx(m,{variant:"h3",gutterBottom:!0,children:"Analytics Rules"}),s.jsxs(m,{sx:{pb:2},children:["This section allows you to configure rules to capture search analytics."," ",s.jsxs(B,{href:"https://typesense.org/docs/29.0/api/analytics-query-suggestions.html",target:"_blank",rel:"noopener noreferrer",children:["Docs ",s.jsx(D,{fontSize:"inherit",sx:{ml:.25}})]})]}),s.jsx(N,{sx:{maxWidth:800},children:s.jsx(O,{})})]})};export{L as component};
